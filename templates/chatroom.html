<!-- templates/chatroom.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Chat Room</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .room-info {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        #chat {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin-bottom: 10px;
            background-color: white;
        }
        .message {
            margin: 5px 0;
            padding: 8px;
            border-radius: 5px;
            background: #f8f9fa;
        }
        .input-area {
            display: flex;
            gap: 10px;
        }
        input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .join-requests {
            margin-top: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="room-info">
            <h2>Chat Room</h2>
            <p>Room Code: <span id="currentCode">{{ display_code }}</span></p>
            <div id="member-count">Members Online: <span id="count">{{ participant_count }}</span></div>
            <div id="code-timer">Next code update in: <span id="timer">5:00</span></div>
        </div>

        <div id="join-requests-container"></div>
        <div id="chat"></div>
        
        <div class="input-area">
            <input id="message" 
                   type="text" 
                   placeholder="Type your message..." 
                   maxlength="{{ MAX_MESSAGE_LENGTH }}"
                   onkeypress="if(event.key === 'Enter') { event.preventDefault(); sendMessage(); }">
            <button onclick="sendMessage()">Send</button>
            <button onclick="leaveChat()">Leave</button>
        </div>
    </div>

    <script>
        const socket = io({
            query: {
                room: "{{ room_code }}",
                csrf_token: "{{ csrf_token() }}"
            },
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 1000,
            timeout: 20000
        });

        // Add connection error handling
        socket.on('connect_error', (error) => {
            console.log('Connection Error:', error);
            // Attempt to reconnect after 5 seconds
            setTimeout(() => {
                socket.connect();
            }, 5000);
        });

        socket.on('disconnect', (reason) => {
            console.log('Disconnected:', reason);
            if (reason === 'io server disconnect') {
                // Reconnect if server disconnected
                socket.connect();
            }
        });

        // Add ping/pong to keep connection alive
        setInterval(() => {
            socket.emit('ping');
        }, 25000);

        socket.on('connect', function() {
            socket.emit('join', {
                room: "{{ room_code }}"
            });
            socket.emit('request_timer_sync', { room: "{{ room_code }}" });
        });

        // Encryption setup
        const roomKey = "{{ room_code }}";
        const encryptionKey = "{{ encryption_key }}";
        
        function encryptMessage(message) {
            try {
                const salt = CryptoJS.lib.WordArray.random(128/8);
                const key = CryptoJS.PBKDF2(roomKey + encryptionKey, salt, {
                    keySize: 256/32,
                    iterations: 1000
                });
                const encrypted = CryptoJS.AES.encrypt(message, key.toString());
                return JSON.stringify({
                    salt: salt.toString(),
                    content: encrypted.toString()
                });
            } catch (e) {
                console.error('Encryption error:', e);
                return null;
            }
        }

        function decryptMessage(encryptedData) {
            try {
                const parsedData = JSON.parse(encryptedData);
                const salt = CryptoJS.enc.Hex.parse(parsedData.salt);
                
                const key = CryptoJS.PBKDF2(roomKey + encryptionKey, salt, {
                    keySize: 256/32,
                    iterations: 1000
                });
                const decrypted = CryptoJS.AES.decrypt(parsedData.content, key.toString());
                return decrypted.toString(CryptoJS.enc.Utf8);
            } catch (e) {
                console.error('Decryption error:', e);
                return 'Message cannot be decrypted';
            }
        }

        // Message sending function
        function sendMessage() {
            const messageInput = document.getElementById('message');
            const message = messageInput.value.trim();
            
            if (message) {
                console.log('Sending message:', message); // Debug log
                const encryptedMessage = encryptMessage(message);
                
                if (encryptedMessage) {
                    console.log('Encrypted message:', encryptedMessage); // Debug log
                    socket.emit('message', {
                        message: encryptedMessage,
                        room: "{{ room_code }}"
                    });
                    messageInput.value = '';
                } else {
                    console.error('Failed to encrypt message');
                }
            }
        }

        // Message receiving
        socket.on('message', function(data) {
            console.log('Received message:', data); // Debug log
            const chat = document.getElementById('chat');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            try {
                const decryptedContent = decryptMessage(data.content);
                console.log('Decrypted content:', decryptedContent); // Debug log
                messageDiv.innerHTML = `<strong>${data.sender}</strong> (${data.timestamp}): ${decryptedContent}`;
            } catch (e) {
                console.error('Decryption failed:', e);
                messageDiv.innerHTML = `<strong>${data.sender}</strong> (${data.timestamp}): [Encrypted Message]`;
            }
            
            chat.appendChild(messageDiv);
            chat.scrollTop = chat.scrollHeight;
        });

        // Timer synchronization
        let timeLeft = {{ initial_time }};
        const timerElement = document.getElementById('timer');
        let timerInterval;

        function startTimer(initialTime) {
            // Clear existing timer if any
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            timeLeft = initialTime;
            updateTimer(); // Update immediately
            
            timerInterval = setInterval(() => {
                timeLeft = Math.max(0, timeLeft - 1);
                updateTimer();
                
                // Request sync when timer gets close to zero
                if (timeLeft <= 1) {
                    socket.emit('request_timer_sync', { room: "{{ room_code }}" });
                }
            }, 1000);
        }

        function updateTimer() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // Start timer on initial load
        startTimer({{ initial_time }});

        // Handle timer sync response
        socket.on('timer_sync', function(data) {
            startTimer(data.time_remaining);
        });

        // Update code_update handler
        socket.on('code_update', function(data) {
            document.getElementById('currentCode').textContent = data.new_code;
            startTimer(300); // Reset timer to 5 minutes
        });

        // Request timer sync periodically
        setInterval(() => {
            socket.emit('request_timer_sync', { room: "{{ room_code }}" });
        }, 10000); // Sync every 10 seconds

        // Join request handling
        socket.on('join_request', function(data) {
            if (!document.querySelector(`[data-user-id="${data.user_id}"]`)) {
                const container = document.getElementById('join-requests-container');
                const requestDiv = document.createElement('div');
                requestDiv.className = 'join-request';
                requestDiv.setAttribute('data-user-id', data.user_id);
                requestDiv.innerHTML = `
                    <p>${data.user} wants to join the room</p>
                    <div class="approval-status">Waiting for all members to approve (60s)</div>
                    <button onclick="handleJoinRequest('${data.user_id}', true)">Accept</button>
                    <button onclick="handleJoinRequest('${data.user_id}', false)">Deny</button>
                `;
                container.appendChild(requestDiv);
                
                // Add timer for this request
                const timerDiv = requestDiv.querySelector('.approval-status');
                let timeLeft = 60;
                const timer = setInterval(() => {
                    timeLeft--;
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        requestDiv.remove();
                    } else {
                        timerDiv.textContent = `Waiting for all members to approve (${timeLeft}s)`;
                    }
                }, 1000);
            }
        });

        socket.on('partial_approval', function(data) {
            const requestDiv = document.querySelector(`[data-user-id="${data.user_id}"]`);
            if (requestDiv) {
                const statusDiv = requestDiv.querySelector('.approval-status');
                statusDiv.textContent = `Approvals: ${data.approvals}/${data.required}`;
            }
        });

        function handleJoinRequest(userId, approved) {
            console.log('Handling join request:', userId, approved);
            const eventName = approved ? 'approve_join' : 'deny_join';
            socket.emit(eventName, {
                user_id: userId,
                room: "{{ room_code }}"
            });
            // Remove request UI for all participants
            const requestDiv = document.querySelector(`[data-user-id="${userId}"]`);
            if (requestDiv) {
                requestDiv.remove();
            }
        }

        // When someone is approved, remove their request UI for all participants
        socket.on('join_approved', function(data) {
            const requestDiv = document.querySelector(`[data-user-id="${data.user_id}"]`);
            if (requestDiv) {
                requestDiv.remove();
            }
            // Sync timer if time is provided
            if (data.current_time) {
                timeLeft = 300 - ((Math.floor(Date.now() / 1000) - data.current_time) % 300);
            }
        });

        // Participant count handling
        socket.on('update_participants', function(data) {
            document.getElementById('count').textContent = data.count;
        });

        // Handle disconnection
        window.addEventListener('beforeunload', function() {
            socket.disconnect();
        });

        function leaveChat() {
            socket.disconnect();
            window.location.href = '/';
        }
    </script>
</body>
</html>